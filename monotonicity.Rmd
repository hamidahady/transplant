---
title: Investigating the thoracic data
author:

- Hamidreza Ahady Dolatsara^[Auburn University, [hamid@auburn.edu](mailto:hamid@auburn.edu)]
- Fadel Megahed^[University of Miami Ohio, [fmegahed@miamioh.edu](mailto:fmegahed@miamioh.edu)]
- Ying-Ju Tessa Chen^[Dayton University, [ychen4@udayton.edu](mailto:ychen4@udayton.edu)]
- Christy Evans^[Auburn University, [cje0010@auburn.edu](mailto:cje0010@auburn.edu)]
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    number_sections: yes
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
---

  

****



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In the following block, required ***R*** libraries are checked for existance and then installed if it's needed.


```{r, message=FALSE, cache=FALSE, error=FALSE}

rm(list = ls()) # clears global environment (functions and variables)
graphics.off() # clears graphics
if(!("pacman" %in% rownames(installed.packages()))){install.packages("pacman")}# pacman would be installed if it's not existed
library(pacman) 
p_load(caret,httr, DT,stringr)

# I load functions from this source
#replace by github
#source("https://raw.githubusercontent.com/hamidahady/transplant/Hamid/all_functions.R")
source("C:/Users/hza0020/Box/Transplant/Thesis/github/transplant/transplant/all_functions.R")

 
```
Here we check different values that a variable might have.
```{r , message=FALSE, cache=TRUE, error=FALSE, results="hide", warning=FALSE}

# first I download the data from github and then merge them into one large file named thoracic_data
{
file1<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_1_9000L.rds?raw=true"))
file2<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_9001_18000L.rds?raw=true"))
file3<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_18001_27000L.rds?raw=true"))
file4<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_27001_36000L.rds?raw=true"))
file5<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_36001_45000L.rds?raw=true"))
file6<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_45001_54000L.rds?raw=true"))
file7<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_54001_63000L.rds?raw=true"))
file8<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_63001_72000L.rds?raw=true"))
file9<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_72001_81000L.rds?raw=true"))
file10<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_81001_90000L.rds?raw=true"))
file11<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_90001_99000L.rds?raw=true"))
file12<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_99001_108000L.rds?raw=true"))
file13<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_108001_117000L.rds?raw=true"))
file14<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_117001_126000L.rds?raw=true"))
file15<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_126001_135000L.rds?raw=true"))
file16<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_135001_144000L.rds?raw=true"))
file17<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_144001_153000L.rds?raw=true"))
file18<-readRDS(url("https://github.com/hamidahady/transplant/blob/master/data/raw/thoracic_data_153001_159318L.rds?raw=true"))


thoracic_data<-rbind(file1,file2,file3,file4,file5,file6,file7,file8,file9,file10,file11,file12,file13,file14,file15,file16,
                     file17,file18)

rm(list = c("file1","file2","file3","file4","file5","file6","file7","file8","file9","file10","file11","file12","file13",
            "file14","file15","file16","file17","file18"))
}
#####end of importing the data
  
var_table<-matrix(NA, ncol = 2, nrow = ncol(thoracic_data))
var_table<-as.data.frame(var_table)
names(var_table) <- c("vars","data")

var_table$vars<-colnames(thoracic_data)

for(i in 1:ncol(thoracic_data)){
  if(length(as.data.frame(table(thoracic_data[i]))[,1])<100){
    var_table$data[i]<-paste(as.data.frame(table(thoracic_data[i]))[,1],collapse=",")
  }else{var_table$data[i]<-"numeric or too many levels"}
  
  
}

# our dataset has patient data from 1987 to 2016
#variables changed overtime, some of them are added very late, it means for majority of patiesnts, no values are recorded.
#Also some variables are taken out of the dataset longtime ago, it means for majority of patiesnts, no values are recorded.

# Step 1: Identifying the variables that did not end & those added before 2000

# first I import a major file about the variables

# in this dataset, the NA values are specified in different formats: NA, "", " ", UNK, ...
# in this block I convert those values to NA for a better investigation
{
var_desc<-read.csv("https://raw.githubusercontent.com/hamidahady/transplant/Hamid/data/var_desc.csv")
thoracic_data<-na_maker(thoracic_data,var_desc$VARIABLE.NAME,var_desc$nas) 
  }
###

#trimming out their space from date
var.end.dates <- trimws(var_desc$VAR.END.DATE) %>% stringr::str_trim()
if.var.did.not.end <- which(var.end.dates=="")

names.of.var.did.not.end <- var_desc[if.var.did.not.end, "VARIABLE.NAME"] 
  
vars.added.dates <- var_desc$VAR.START.DATE %>% as.character.Date()

#changing variable adding date from "01-Oct-87, 01-Oct-90") to "01-Oct-90"
vars.added.dates[which(vars.added.dates=="01-Oct-87, 01-Oct-90")] <- "01-Oct-90"
vars.added.years<- sapply(vars.added.dates, function(x) str_extract_all(x,"[0-9]{1,2}")[[1]][2]) %>% as.integer()
var_desc$YR_ADDED <- vars.added.years
vars.added.df <- subset(var_desc,(YR_ADDED>=87 | is.na(YR_ADDED)) ,
                                select = c(1))  # available variables added before 2000 or has unkown adding date

#making variables as a vector
vars.added.all <- vars.added.df[["VARIABLE.NAME"]] %>% 
                  as.character()

# we excluded patients who just had heart transplant, and did it after year 2000
heart.df.cleaned <- subset(thoracic_data,WL_ORG=="HR") %>% 
 # the next line is excluded since they might live more than 12 years but the status is NA
 # subset(is.na(GSTATUS)==FALSE)  %>% 
  subset(TX_YEAR>=2000)  %>%
  subset(select=intersect(names.of.var.did.not.end,vars.added.all))


# end of identifying NAs

# Step 2: Identifying the variables that are post transplant
# Based on observations from the Form and Form Section Descriptors
vars.post.trans.index1 <-  sapply(var_desc$FORM.SECTION,
                                  function(x) str_detect(x,
                                                        "POST TRANSPLANT CLINICAL INFORMATION"))
vars.post.trans.index2 <-  sapply(var_desc$FORM,
                                  function(x) str_detect(x,
                                                         "TRF/TRR|TRR/TRF-CALCULATED|TRR/TRF|TRF"))

vars.post.trans <- var_desc[as.logical(vars.post.trans.index1+vars.post.trans.index2),][,1] %>%
  as.character()

vars.post.trans <- intersect(colnames(heart.df.cleaned),
                             vars.post.trans)

heart.df.cleaned<-heart.df.cleaned[which(!colnames(heart.df.cleaned) %in% vars.post.trans)]


#assigning the actual type of the variables
{
  
}
########################

# change NA equivalents to NA

for(i in 1:ncol(heart.df.cleaned)){
  for (j in 1:nrow(var_desc)) {
    if(names(heart.df.cleaned)[i]==var_desc$VARIABLE.NAME[j]){
      if(var_desc$Hamid_TYPE[j]=="CHAR"){heart.df.cleaned[i]<-as.character(heart.df.cleaned[i])}
      if(var_desc$Hamid_TYPE[j]=="NUM"){heart.df.cleaned[i]<-as.numeric(heart.df.cleaned[i])}
      if(var_desc$Hamid_TYPE[j]=="D"){heart.df.cleaned[i]<-NA}
    }
      
  }
}



{


  NA_cells<-c(""," ","U")
  for(i in 1:length(NA_cells)){
    
    heart.df.cleaned[heart.df.cleaned == NA_cells[i]] <- NA
    gc()}
  }
heart.df.cleaned[1:54] == ""
str(heart.df.cleaned[54:55,120])
str(heart.df.cleaned[181:180])


heart.df.cleaned[heart.df.cleaned == ""] <- NA
gc()
heart.df.cleaned[heart.df.cleaned == " "] <- NA
gc()
heart.df.cleaned[heart.df.cleaned == "U"] <- NA
gc()







thoracic_data[82]



```
<br />
<br />
If the levels of variables are more than 100, I assume they are numerical or there are uselessly too many levels. Some of variables are empty and some of them have a lot of levels (like states' name). Here, you can see possible values of different variables in the thoracic dataset:
```{r , message=FALSE, cache=FALSE, error=FALSE}
  DT::datatable(var_table)
```

```{r , message=FALSE, cache=FALSE, error=FALSE}

# I bring the data set who has information about which values mean NA, then convert those to NA in the dataset


 
```








